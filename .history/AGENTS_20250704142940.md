## Инструкции для Агента

**Основные принципы работы:**

1.  **Анализ `AGENTS.md`:** Перед началом любой работы всегда анализировать этот файл (`AGENTS.md`).
2.  **Работа с задачами из `tasks.txt`:**
    *   Взять одну задачу из файла `tasks.txt` в разработку.
    *   Полностью реализовать задачу.
    *   Покрыть тестами (если требуется).
    *   Провести тестирование:
        *   Запустить тесты.
        *   Если тест падает, сначала исправить ошибку, затем повторно запустить тест.
        *   Повторять до тех пор, пока все тесты, относящиеся к задаче, не пройдут.
    *   После успешной реализации и тестирования:
        *   Удалить задачу из файла `tasks.txt`.
        *   Перенести (добавить) информацию о выполненной задаче в файл `done.txt`.
3.  **Отложенные задачи:**
    *   Если задача будет требовать доработки в будущем, создать в этом файле (`AGENTS.md`) секцию "Отложенные задачи".
    *   Указать в этой секции задачу, которую необходимо будет доработать, и указать, когда именно это нужно будет сделать.
4.  **Обновление `AGENTS.md` и Коммит:**
    *   Если все тесты по текущей задаче успешно прошли, обновить `AGENTS.md` информацией о проделанной работе (в секции "Лог действий").
    *   Сделать коммит с описанием изменений.
5.  **Локальная память в `AGENTS.md`:**
    *   `AGENTS.md` используется как ваша локальная память для отслеживания прогресса, контекста и принятых решений.
    *   Каждое действие, предпринятое для реализации текущей задачи, должно быть немедленно записано в `AGENTS.md` в секции "Лог действий" под заголовком текущей задачи.
6.  **Планирование текущей задачи:**
    *   Перед началом реализации новой задачи необходимо составить детальный план ее выполнения.
    *   Этот план записывается в секцию "Текущий план" в `AGENTS.md`. По завершении задачи эта секция очищается или обновляется для следующей задачи.
7.  **Приоритет инструкций:**
    *   Явные инструкции от пользователя, полученные в ходе текущего диалога, имеют наивысший приоритет.
    *   Затем следуют инструкции из этого раздела ("Инструкции для Агента").

**Структура `AGENTS.md` (Рекомендуемая):**

*   **Инструкции для Агента:** (Этот раздел)
*   **Текущий план:**
    *(Этот раздел будет заполняться планом для следующей задачи)*
*   **Отложенные задачи:**
    *(Этот раздел будет заполняться, если появятся задачи, требующие доработки в будущем)*
*   **Лог действий:** Хронологический список всех предпринятых действий с указанием контекста задачи, сгруппированных по задачам. Задачи нумеруются.

---

## Текущий план
*(Этот раздел будет заполняться планом для следующей задачи)*
---
## Отложенные задачи
*(Этот раздел будет заполняться, если появятся задачи, требующие доработки в будущем)*

---

## Лог действий

## Задача 27: ⚔️ 5.2 Combat Engine Module
- **Анализ требований и существующего кода**:
    - Проанализированы требования к API `process_combat_action` из `Tasks.txt`.
    - Изучен существующий `src/core/combat_engine.py` и связанные модели (`CombatEncounter`, `Player`, `GeneratedNpc`, `CombatActionResult`, `CheckResult`).
    - Выявлена необходимость интеграции правил из `RuleConfig`, полноценного использования `resolve_check` и детализированного расчета урона.
- **Доработка `CombatActionResult`**:
    - В `src/models/combat_outcomes.py` уточнена аннотация типа для `check_result` на `Optional[CheckResult]` вместо `Optional[Dict[str, Any]]`.
    - Для разрешения прямого импорта `CheckResult` его определение (вместе с `ModifierDetail`, `CheckOutcome`) перенесено из `src/core/check_resolver.py` в новый файл `src/models/check_results.py`.
    - В `src/models/__init__.py` добавлены импорты новых моделей (`CheckResult`, `CheckOutcome`, `ModifierDetail`) и вызовы `model_rebuild()` для `CombatActionResult` и этих моделей для корректной обработки forward-ссылок Pydantic.
- **Доработка `process_combat_action` в `src/core/combat_engine.py`**:
    - **Загрузка данных**: Улучшена загрузка `CombatEncounter` (с использованием `guild_id`), актора и цели. Улучшена обработка ошибок при отсутствии сущностей.
    - **Вспомогательные функции**:
        - `_get_combat_rule`: Для получения правил боя, с приоритетом из `combat_encounter.rules_config_snapshot_json`, затем из `RuleConfig` (`core.rules.get_rule`).
        - `_get_participant_stat`: Для получения статов участника боя, с приоритетом из `participant_data` (в `CombatEncounter.participants_json`), затем из базовой модели (`Player`, `GeneratedNpc.properties_json.stats`), с возможностью расчета модификаторов (`_modifier` в названии стата).
        - `_calculate_attribute_modifier`: Для расчета модификатора атрибута на основе базового значения и формулы из `RuleConfig` (например, `(value - 10) // 2`).
    - **Логика действия "attack"**:
        - **Получение правил**: Динамическое получение правил для действия "attack" (тип проверки, атрибуты для атаки/урона, DC, формула урона, правила крит. удара) с использованием `_get_combat_rule`.
        - **Расчет DC**: DC для атаки рассчитывается как `dc_base` (из правил) + модификатор атрибута цели (например, ловкости, из правил).
        - **Разрешение проверки**: Вызов `core.check_resolver.resolve_check` с передачей рассчитанного DC, типа проверки, деталей актора/цели. Обработано исключение `CheckError`.
        - **Расчет урона**:
            - Если проверка успешна: получается модификатор атрибута урона актора. Формула урона (из правил, например, "1d6+@actor_strength_modifier") обрабатывается: плейсхолдер модификатора заменяется рассчитанным значением. `core.dice_roller.roll_dice` вызывается для полученной строки формулы.
            - Применяется множитель критического урона (из правил), если результат проверки - крит. успех.
            - Урон не может быть отрицательным.
        - **Обновление HP**: HP цели обновляется в `participants_data` (in-memory список для `combat_encounter.participants_json`).
        - **Формирование описания**: Генерируется текстовое описание исхода атаки.
        - **`CombatActionResult`**: Заполняется всеми деталями (успех, урон, результат проверки, описание, использованные правила).
    - **Обработка неизвестных действий**: Возвращается `CombatActionResult` с сообщением об ошибке.
    - **Обновление состояния боя**: `combat_encounter.participants_json` и `combat_encounter.combat_log_json` обновляются.
    - **Логирование StoryLog**: Вызов `core.game_events.log_event` с полными `details_json` (включая `action_result`) и корректным `entity_ids_json` (актор и цель). Удален дублирующийся вызов `log_event`.
- **Обновление Unit-тестов в `tests/core/test_combat_engine.py`**:
    - Тесты переписаны с использованием корректных техник мокирования для `async def` функций и их `side_effect` (использование `async def` функции в качестве `side_effect` для `AsyncMock`).
    - Исправлены цели патчей для функций, импортируемых в `combat_engine.py` (например, `patch('src.core.combat_engine.get_rule', ...)` вместо `patch('src.core.rules.get_rule', ...)`).
    - Мок для `dice_roller.roll_dice` изменен на `MagicMock`, так как функция синхронная.
    - Мок для `resolve_check` в тесте на `CheckError` теперь напрямую присваивает экземпляр исключения в `side_effect`.
    - Покрыты сценарии: успешная атака (попадание, урон, обновление HP), промах, критическое попадание, использование правил из snapshot, ошибки (бой/актор/цель не найдены, ошибка в `resolve_check`).
    - Все 7 тестов успешно пройдены после исправлений.
- **Административные действия по завершению предыдущей задачи (Task 26)**:
    - Задача 26 удалена из `Tasks.txt`.
    - Задача 26 добавлена в `Done.txt`.

## Задача 19 (старая): 📚 7.3 Turn and Report Formatting (Guild-Scoped) - Revisit
- **Цель пересмотра**: Расширить поддержку форматирования для большего числа типов событий в `src/core/report_formatter.py`.
- **Определение приоритетных типов событий**:
    - На основе анализа `_collect_entity_refs_from_log_entry` и `_format_log_entry_with_names_cache` были определены следующие типы событий для добавления форматирования: `COMBAT_START`, `QUEST_ACCEPTED`, `QUEST_STEP_COMPLETED`, `QUEST_COMPLETED`, `LEVEL_UP`, `XP_GAINED`, `RELATIONSHIP_CHANGE`, `STATUS_APPLIED`.
- **Реализация форматирования**:
    - В функцию `_format_log_entry_with_names_cache` добавлены блоки `elif` для каждого из 8 приоритетных типов событий.
    - Для каждого типа события реализована логика извлечения данных из `log_entry_details_json`, использования `get_name_from_cache` для имен сущностей и `get_term` для локализуемых строк и шаблонов сообщений.
- **Добавление Unit-тестов**:
    - В `tests/core/test_report_formatter.py` добавлены новые параметризованные тесты для каждого из 8 новых форматов событий.
    - Тесты проверяют корректность форматирования для языков `en` и `ru`, использование кеша имен и терминов из `RuleConfig` (через моки).
- **Рассмотрение дополнительных типов событий (опционально)**:
    - Были рассмотрены другие типы событий из `EventType`. Принято решение добавить форматирование для `DIALOGUE_LINE`, `STATUS_REMOVED` и `QUEST_FAILED` как наиболее критичных для полноты отчетов.
    - Обновлена функция `_collect_entity_refs_from_log_entry` для корректного сбора ссылок на сущности для `DIALOGUE_LINE` и `QUEST_FAILED` (для `STATUS_REMOVED` существующая логика для `STATUS_APPLIED` подходит).
    - В `_format_log_entry_with_names_cache` добавлена логика форматирования для `DIALOGUE_LINE`, `STATUS_REMOVED`, `QUEST_FAILED`.
    - В `tests/core/test_report_formatter.py` добавлены соответствующие unit-тесты для этих трех дополнительных типов событий.
- **Обзор и рефакторинг**:
    - Проведен обзор внесенных изменений. Код соответствует существующим паттернам. Вопрос передачи сессии в `get_rule` через форматер остается известной особенностью, не требующей немедленного рефакторинга в рамках данной задачи.
- **Результат**: Модуль форматирования отчетов теперь поддерживает значительно большее количество типов событий, улучшая детализацию и информативность логов для игроков.
- **Рефакторинг (Сессия 2024-07-04):**
    - **Устранение проблемы с `AsyncSession` в `_format_log_entry_with_names_cache`**:
        - Модифицирована `_format_log_entry_with_names_cache` для приема `AsyncSession` в качестве первого параметра.
        - Внутренняя функция `get_term` обновлена для использования этой сессии при вызове `core.rules.get_rule`.
        - Функция `format_turn_report` обновлена для передачи `AsyncSession` в `_format_log_entry_with_names_cache`.
        - Unit-тесты в `tests/core/test_report_formatter.py` скорректированы для передачи `mock_session` в вызовы `_format_log_entry_with_names_cache`.
    - **Улучшение логики языкового fallback в `get_term`**:
        - Реализован многоуровневый fallback:
            1. Запрошенный язык из `RuleConfig`.
            2. Основной fallback-язык ("en") из `RuleConfig`.
            3. Запрошенный язык из `default_text_map`.
            4. Основной fallback-язык ("en") из `default_text_map`.
            5. Первое доступное значение из `default_text_map`.
            6. Пустая строка, если термин не найден.
    - Все тесты (356) успешно пройдены после изменений.

## Текущая сессия: Анализ и доработка Задач 1.1 и 1.2 (старый лог)
- ... (содержимое этого лога опущено для краткости, так как оно нерелевантно для текущей задачи) ...

## Задача 19 (старый лог): 📚 7.3 Turn and Report Formatting (Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 23: 🗺️ 4.1 Location Model (i18n, Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 21: 🧠 3.2 Entity Status Model (i18n, Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 18: 📚 7.2 AI Narrative Generation (Multilang)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 20: 🧠 3.1 Ability Model (i18n, Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 26: ⚔️ 5.1 Combat and Participant Model (Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 1: 🗺️ 4.3 Location Transitions (Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 2: 🧠 3.3 API for Activating Abilities and Applying Statuses (Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 3: Пользовательская задача: Полный цикл тестов и покрытие нового функционала
- ... (содержимое этого лога опущено для краткости) ...

## Задача 4: Пользовательская задача: Рефакторинг проекта
- ... (содержимое этого лога опущено для краткости) ...

## Задача 5: Пользовательская задача: Исправление ошибок Pyright
- ... (содержимое этого лога опущено для краткости) ...

## Задача 6: Пользовательская задача: Исправление ошибок Pyright
- ... (содержимое этого лога опущено для краткости) ...

## Задача 7: Пользовательская задача: Создание мок-тестов и исправление ошибок
- ... (содержимое этого лога опущено для краткости) ...

## Задача 8: 🎲 6.3.2 Check Resolver Module
- ... (содержимое этого лога опущено для краткости) ...

## Задача 9: 🎲 6.3.1 Dice Roller Module
- ... (содержимое этого лога опущено для краткости) ...

## Задача 10: Сессия [Текущая дата/время]: Начало работы
- ... (содержимое этого лога опущено для краткости) ...

## Задача 11: 🚀 0.1 Discord Bot Project Initialization
- ... (содержимое этого лога опущено для краткости) ...

## Задача 12: 🗄️ 0.2 DBMS Setup and Database Model Definition
- ... (содержимое этого лога опущено для краткости) ...

## Задача 13: 🛠️ 0.3 Core Utils
- ... (содержимое этого лога опущено для краткости) ...

## Задача 14: 🌍 1.1 Location Model, Utils, and Default Population
- ... (содержимое этого лога опущено для краткости) ...

## Задача 15: 👥 1.2 Player and Party System
- ... (содержимое этого лога опущено для краткости) ...

## Задача 16: 🚶 1.3 Movement Logic and Command
- ... (содержимое этого лога опущено для краткости) ...

## Задача 17: 📦 2.1 Finalize Definition of ALL DB Schemas
- ... (содержимое этого лога опущено для краткости) ...

## Задача 18 (старый): 🤖 2.2 AI Prompt Preparation Module
- ... (содержимое этого лога опущено для краткости) ...

## Задача 19 (очень старый): ✅ 2.3 AI Prompt Construction Logic
- ... (содержимое этого лога опущено для краткости) ...

## Задача 20 (старый): 🧠 2.6 AI Generation, Moderation, and Saving Logic
- ... (содержимое этого лога опущено для краткости) ...

## Задача 21 (старый): ⚙️ 6.10 Action Parsing and Recognition Module
- ... (содержимое этого лога опущено для краткости) ...

## Задача 22: ⚙️ 6.12 Turn Queue System
- ... (содержимое этого лога опущено для краткости) ...

## Задача 23 (старый): ⚙️ 6.11 Central Collected Actions Processing Module
- ... (содержимое этого лога опущено для краткости) ...

## Задача 24: 🗺️ 4.2 Guild Map Generation and Editing (Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 25 (старый): Пользовательская задача: Написать тест для main.py
- ... (содержимое этого лога опущено для краткости) ...

## Задача 26 (старый): Пользовательская задача: Исправление ошибок импорта и TypeError
- ... (содержимое этого лога опущено для краткости) ...

## Задача 27 (старый): Важное примечание о миграциях Alembic
- ... (содержимое этого лога опущено для краткости) ...

## Задача 28: 📚 7.1 Event Log Model (Story Log, i18n, Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 29: ⚙️ 6.1.1 Intra-Location Interaction Handler Module
- ... (содержимое этого лога опущено для краткости) ...

## Задача 30: Пользовательская задача: Исправление ошибок в тестах
- ... (содержимое этого лога опущено для краткости) ...

## Задача 31: 📚 7.2 AI Narrative Generation (Multilang)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 32: 📚 7.3 Turn and Report Formatting (Guild-Scoped)
- ... (содержимое этого лога опущено для краткости) ...

## Задача 33: Пользовательская задача: Полное покрытие тестами и исправление ошибок
- ... (содержимое этого лога опущено для краткости) ...

## Задача 34: Пользовательская задача: Исправление ошибок Pyright
- ... (содержимое этого лога опущено для краткости) ...

## Задача 35: Пользовательская задача: Проверка и исправление тестов
- ... (содержимое этого лога опущено для краткости) ...

## Задача 36: Пользовательская задача: Исправление ошибок Pyright и стабилизация тестов
- ... (содержимое этого лога опущено для краткости) ...
