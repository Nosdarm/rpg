## Инструкция для агента

1.  **Ознакомление с задачами:** Внимательно прочитать файл `tasks` для понимания всего объема работ.
2.  **Выбор задачи:** Взять одну задачу из файла `tasks` для реализации.
3.  **Планирование:**
    *   Создать детальный план для реализации выбранной задачи.
    *   Записать план в `AGENTS.md` в секцию "Текущий план".
4.  **Реализация:**
    *   Написать код для выполнения задачи.
    *   Создать или обновить необходимые файлы.
    *   Провести тестирование (если применимо).
5.  **Документирование действий:**
    *   Каждое значимое действие (создание файла, изменение функции, запуск тестов и т.д.) должно быть записано в `AGENTS.md` в секцию "Лог действий".
6.  **Завершение задачи:**
    *   После успешной реализации и тестирования, записать выполненную задачу в файл `done.txt`.
    *   Удалить выполненную задачу из файла `tasks`.
7.  **Повторение:** Вернуться к шагу 2, если в файле `tasks` остались невыполненные задачи.
8.  **Отправка изменений:** После выполнения всех задач, отправить изменения с соответствующим коммитом.

## Лог действий

(Здесь будут записываться действия)
- Попытка создать директории проекта (`src/bot`, `src/core`, `src/models`, `src/utils`, `src/config`, `tests/`) с помощью `mkdir`. (Неудачно, директории не создались).
- Принято решение создавать файлы напрямую, так как `create_file_with_block` должен создавать родительские директории.
- Созданы основные файлы проекта:
    - `src/main.py`
    - `src/bot/core.py`
    - `src/bot/events.py`
    - `src/bot/commands.py`
    - `src/config/settings.py`
    - `requirements.txt`
    - `.gitignore`
    - `src/bot/__init__.py`
    - `src/config/__init__.py`
    - `src/__init__.py`
    - `tests/__init__.py`
- Директории `src/core/`, `src/models/`, `src/utils/` пока не содержат файлов, но пути для них существуют благодаря созданию `src/__init__.py` и других файлов в `src/`. Они будут наполняться по мере реализации соответствующих задач.
- Реализована базовая структура `BotCore` в `src/bot/core.py`:
    - Конструктор `__init__` принимает `command_prefix` и `intents`.
    - Метод `setup_hook` для асинхронной настройки и загрузки расширений (когов).
    - Реализована загрузка когов `bot.events` и `bot.commands` с обработкой возможных ошибок.
    - Метод `on_ready` для логирования информации о подключении бота и серверах.
- Реализованы обработчики основных событий Discord в `src/bot/events.py` в виде `EventCog`:
    - `on_ready`: Логирование.
    - `on_message`: Базовая обработка (игнор самого себя).
    - `on_guild_join`: Логирование и попытка отправки приветственного сообщения.
    - `on_guild_remove`: Логирование.
    - `on_command_error`: Базовый обработчик ошибок команд.
- Реализована команда `/ping` (текстовая команда, префикс зависит от конфигурации) в `src/bot/commands.py` в виде `CommandCog`:
    - Команда `ping_command` отвечает задержкой бота.
    - Включает логирование вызова команды.
- Настроено логирование:
    - Базовая конфигурация `logging.basicConfig` в `src/main.py`.
    - Формат логирования: `%(asctime)s:%(levelname)s:%(name)s: %(message)s`.
    - Уровень логирования теперь устанавливается из переменной `LOG_LEVEL` в `src/config/settings.py` (по умолчанию INFO).
- Задача 0.1 (Discord Bot Project Initialization and Basic Guild Integration) записана как выполненная в `Done.txt`.
- Задача 0.1 удалена из файла `Tasks.txt`.
- **Задача 0.2 Шаг 1: Определена базовая модель `GuildConfig`**
    - Создан `src/models/base.py` с классом `Base(AsyncAttrs, DeclarativeBase)`.
    - Создан `src/models/guild.py` с моделью `GuildConfig`, включающей поля: `id` (PK, BigInteger), `master_channel_id` (BigInteger, nullable), `system_channel_id` (BigInteger, nullable), `notification_channel_id` (BigInteger, nullable), `main_language` (Text, default 'en').
    - Создан `src/models/__init__.py` для импорта `Base` и моделей (пока только `GuildConfig`), чтобы Alembic мог их обнаружить.
- **Задача 0.2 Шаг 2: Обновлен `requirements.txt`**
    - Добавлены зависимости: `SQLAlchemy>=2.0.20`, `asyncpg>=0.27.0`, `alembic>=1.11.0`.
- **Задача 0.2 Шаг 3: Настроено подключение к БД в `src/config/settings.py`**
    - Добавлены переменные окружения: `DB_TYPE`, `DB_USER`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT`, `DB_NAME` с значениями по умолчанию.
    - Сформирована строка `DATABASE_URL` для `postgresql+asyncpg`.
    - Добавлены информационные сообщения при отсутствии переменных окружения для БД.
    - Обновлен пример `.env` файла.
- **Задача 0.2 Шаг 4: Создан модуль `src/core/database.py` для управления БД**
    - Реализован асинхронный `engine` SQLAlchemy.
    - Реализована фабрика асинхронных сессий `AsyncSessionLocal`.
    - Реализована функция-генератор `get_db_session` для получения сессии с автоматическим commit/rollback/close.
    - Реализована функция `init_db` для создания таблиц на основе метаданных моделей (для первоначальной настройки).
    - Создан `src/core/__init__.py`.
- **Задача 0.2 Шаг 5: Интегрирована `init_db` в `src/main.py`**
    - `init_db()` теперь вызывается в функции `main()` перед запуском бота для создания таблиц, если они отсутствуют.
    - Добавлена обработка ошибок на случай проблем с инициализацией БД.
- **Задача 0.2 Шаг 6: Настроен Alembic для управления миграциями**
    - Выполнена команда `pip install -r requirements.txt` для установки зависимостей, включая `alembic`.
    - Инициализирован Alembic (`alembic init alembic`).
    - Настроен `alembic.ini`: `sqlalchemy.url` теперь будет браться из `env.py`.
    - Настроен `alembic/env.py`:
        - Добавлен путь к `src` в `sys.path`.
        - Импортирован `DATABASE_URL` из `src.config.settings` и установлен как `sqlalchemy.url`.
        - `target_metadata` установлен в `Base.metadata` из `src.models`.
        - Функция `run_migrations_online` адаптирована для работы с асинхронным движком SQLAlchemy.
    - Создана первая миграция `alembic/versions/init_0001_create_guild_configs_table.py` вручную для таблицы `guild_configs` из-за отсутствия БД в среде выполнения для автогенерации. Индекс для `id` сделан уникальным.
- **Задача 0.2 (DBMS Setup and Database Model Definition with Guild ID) записана как выполненная в `Done.txt`**.
- **Задача 0.2 удалена из файла `Tasks.txt`**.

## Текущий план

1.  **Определить базовую модель `GuildConfig` в `src/models/base.py` и `src/models/guild.py`**: (Выполнено)
    *   `GuildConfig` будет содержать: `id` (PK, BIGINT - Discord guild ID), `master_channel_id` (BIGINT, nullable), `system_channel_id` (BIGINT, nullable), `notification_channel_id` (BIGINT, nullable), `main_language` (TEXT, default 'en').
    *   Использовать SQLAlchemy для определения моделей.
    *   Создать `src/models/__init__.py` и `src/models/base.py` для декларативной базы и общих элементов.
2.  **Добавить зависимости для SQLAlchemy и PostgreSQL в `requirements.txt`**: (Выполнено)
    *   `SQLAlchemy>=2.0`
    *   `asyncpg` (для асинхронной работы с PostgreSQL)
    *   `alembic` (для миграций)
3.  **Настроить подключение к базе данных в `src/config/settings.py`**: (Выполнено)
    *   Добавить переменные окружения для данных подключения к БД (user, password, host, port, db_name).
    *   Сформировать `DATABASE_URL`.
4.  **Создать модуль для управления сессиями БД `src/core/database.py`**: (Выполнено)
    *   Реализовать асинхронный `engine` SQLAlchemy.
    *   Реализовать фабрику асинхронных сессий `AsyncSessionLocal`.
    *   Реализовать функцию `get_db_session` для получения сессии (dependency для FastAPI или аналогичных).
    *   Реализовать функцию `init_db` для создания таблиц (для первоначальной настройки, позже будет заменено Alembic).
5.  **Интегрировать `init_db` в `src/main.py`** (для первоначального создания таблиц при запуске, если они не существуют). В дальнейшем это будет заменено Alembic. (Выполнено)
6.  **Настроить Alembic для управления миграциями**: (Выполнено)
    *   Инициализировать Alembic в проекте (`alembic init alembic`).
    *   Настроить `alembic.ini` для указания пути к `env.py` и URL базы данных.
    *   Отредактировать `env.py` для корректного импорта базовой модели SQLAlchemy и настроек подключения.
    *   Создать первую миграцию для модели `GuildConfig`.
7.  **Обновить `AGENTS.md`**:
    *   Записать выполненные действия в "Лог действий".
    *   Обновить "Текущий план".
8.  **Записать выполненную задачу в `Done.txt`** (после полного выполнения всех шагов). (Выполнено)
9.  **Удалить выполненную задачу из `Tasks.txt`** (после полного выполнения всех шагов). (Выполнено)
10. **Предложить пользователю закоммитить изменения**, так как задача 0.1 была завершена, и теперь начинается новая крупная задача 0.2.
