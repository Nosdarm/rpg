## Инструкции для Агента

**Основные принципы работы:**

1.  **Анализ `AGENTS.md`:** Перед началом любой работы всегда анализировать этот файл (`AGENTS.md`).
2.  **Работа с задачами из `Tasks.txt`:**
    *   Взять одну задачу из файла `Tasks.txt` в разработку.
    *   Полностью реализовать задачу.
    *   Покрыть тестами (если требуется).
    *   Провести тестирование:
        *   Запустить тесты.
        *   Если тест падает, сначала исправить ошибку, затем повторно запустить тест.
        *   Повторять до тех пор, пока все тесты, относящиеся к задаче, не пройдут.
    *   После успешной реализации и тестирования:
        *   Удалить задачу из файла `Tasks.txt`.
        *   Перенести (добавить) информацию о выполненной задаче в файл `done.txt`.
3.  **Отложенные задачи:**
    *   Если задача будет требовать доработки в будущем, создать в этом файле (`AGENTS.md`) секцию "Отложенные задачи".
    *   Указать в этой секции задачу, которую необходимо будет доработать, и указать, когда именно это нужно будет сделать.
4.  **Обновление `AGENTS.md` и Коммит:**
    *   Если все тесты по текущей задаче успешно прошли, обновить `AGENTS.md` информацией о проделанной работе (в секции "Лог действий").
    *   Сделать коммит с описанием изменений.
5.  **Локальная память в `AGENTS.md`:**
    *   `AGENTS.md` используется как ваша локальная память для отслеживания прогресса, контекста и принятых решений.
    *   Каждое действие, предпринятое для реализации текущей задачи, должно быть немедленно записано в `AGENTS.md` в секции "Лог действий" под заголовком текущей задачи.
6.  **Планирование текущей задачи:**
    *   Перед началом реализации новой задачи необходимо составить детальный план ее выполнения.
    *   Этот план записывается в секцию "Текущий план" в `AGENTS.md`. По завершении задачи эта секция очищается или обновляется для следующей задачи.
7.  **Приоритет инструкций:**
    *   Явные инструкции от пользователя, полученные в ходе текущего диалога, имеют наивысший приоритет.
    *   Затем следуют инструкции из этого раздела ("Инструкции для Агента").

**Структура `AGENTS.md` (Рекомендуемая):**

*   **Инструкции для Агента:** (Этот раздел)
*   **Текущий план:**
*(Этот раздел будет заполняться планом для следующей задачи)*
*   **Отложенные задачи:**
    *(Этот раздел будет заполняться, если появятся задачи, требующие доработки в будущем)*
*   **Лог действий:** Хронологический список всех предпринятых действий с указанием контекста задачи, сгруппированных по задачам. Задачи нумеруются.

---
## Текущий план
*(Этот раздел будет очищен после завершения текущей сессии работы)*
---
## Лог действий

## Итерация 5: Доработка Task 1.2 и 1.3 (Сессия [Current Date])
- **Дата**: [Current Date]
- **Определение задачи**: Устранение недоработок в Task 1.2 (Player and Party System) и Task 1.3 (Movement Logic) согласно плану, сформированному на основе анализа `AGENTS.md`, `Tasks.txt`, `TODO.md` и `updates.txt`.
- **Выполненные действия**:
    - **Task 1.2 (Система Игроков/Партий)**:
        - `backend/core/crud/crud_player.py` (`create_with_defaults`):
            - Реализовано получение начальных статов (`hp`, `xp`, `level`, `gold`, `unspent_xp`) из `RuleConfig` (ключ `player:starting_stats`).
            - Статус игрока по умолчанию изменен на `PlayerStatus.EXPLORING`.
            - Проверено, что `attributes_json` корректно заполняется из `RuleConfig` (ключ `character_attributes:base_values`).
        - `backend/bot/commands/general_commands.py` (`/start`):
            - Улучшено сообщение для существующего игрока: теперь включает уровень, XP, золото, текущую локацию (если есть), статус в группе и текущий игровой статус.
            - Проверена логика определения стартовой локации через `RuleConfig` (`player:starting_location_static_id`).
        - `backend/bot/commands/party_commands.py`:
            - Улучшено основное сообщение помощи для группы команд `!party`, перечислены все доступные подкоманды.
            - Проверено, что функциональные требования (проверки имени, уникальности, политики выхода из группы, права на роспуск, проверки для вступления в группу) для команд `create`, `leave`, `disband`, `join` в основном реализованы и используют `RuleConfig`.
            - В "Отложенные задачи" добавлена задача по рефакторингу `PartyCog` для использования слеш-команд (`app_commands`) вместо префиксных.
    - **Task 1.3 (Логика Перемещения)**:
        - `backend/core/movement_logic.py` (`execute_move_for_player_action`):
            - Проверена и подтверждена корректность реализации проверок статуса игрока/партии (`movement:allowed_player_statuses`).
            - Проверена и подтверждена корректность реализации проверки условий соединения (`conditions_json`: `requires_world_flag`, `requires_item_static_id`, `requires_quest_status`).
            - Проверена и подтверждена корректность реализации вычета стоимости ресурсов (для инициатора движения) и применения множителей стоимости из свойств локации.
            - Проверена и подтверждена корректность интеграции `check_resolver` для проверок навыков, включая учет модификаторов DC из свойств локации и политик выполнения проверок для партии (`party:movement_skill_check_performer`).
            - Проверена и подтверждена обработка политик движения партии (`party:movement:policy`).
        - `backend/core/game_events.py` (`on_enter_location`):
            - Функция расширена: добавлено логгирование для симуляции отправки описания локации игроку.
            - Добавлены лог-плейсхолдеры для будущей интеграции запуска столкновений и AI-событий.
            - Реализован вызов `quest_system.handle_player_event_for_quest` для события `LOCATION_ENTERED`.
    - **Тестирование**:
        - Исправлены и успешно пройдены все тесты в `tests/core/crud/test_crud_player.py` (9 тестов).
        - Исправлены и успешно пройдены все тесты в `tests/bot/commands/test_general_commands.py` (4 теста).
        - Исправлены и успешно пройдены все тесты в `tests/bot/commands/test_party_commands.py` (16 тестов).
        - Исправлены и успешно пройдены все тесты в `tests/core/test_movement_logic.py` (28 тестов).
        - Успешно пройдены все тесты в `tests/core/test_game_events.py` (10 тестов).
- **Статус**: Доработки по Task 1.2 и 1.3 в рамках текущего плана завершены. Соответствующие компоненты улучшены и протестированы.

## Итерация 4: Завершение Party Commands (Сессия 2025-07-11)
- (Лог действий из исходного AGENTS.md)...

## Итерация 3: Доработка Party Commands и Movement Logic (Сессия 2025-07-11)
- (Лог действий из исходного AGENTS.md)...

## Итерация 2: Улучшение Логики Перемещения и Команды /start (Сессия 2025-07-11)
- (Лог действий из исходного AGENTS.md)...

## Итерация исправлений: Настройки, Модели, Движение (Сессия 2025-07-11)
- (Лог действий из исходного AGENTS.md)...

## Добавление меток к списку недоработок (Сессия [Current Date])
- (Лог действий из исходного AGENTS.md)...

## Всесторонний анализ проекта на недоработки (Задачи 0.1-68) - Завершение
- (Лог действий из исходного AGENTS.md)...

## Всесторонний анализ проекта на недоработки (Задачи 0.1-68) - Часть 1
- (Лог действий из исходного AGENTS.md)...

## Сессия детализации задач (Пользовательский запрос от [Current Date])
- (Лог действий из исходного AGENTS.md)...

## Task 58: 🖥️ UI.4 UI for Rule Configuration (RuleConfig) (Full UI Implementation)
- (Лог действий из исходного AGENTS.md)...

## Task 59: 🖥️ UI.5 UI for AI Generation and Moderation
- (Лог действий из исходного AGENTS.md)...

## Task 68: 🖥️ UI.14 UI "Command List" Section (Help/Guide)
- (Лог действий из исходного AGENTS.md)...

## Детализация задач для `Tasks.txt` (Пользовательский запрос от [Текущая дата] - Продолжение)
- (Лог действий из исходного AGENTS.md)...

## Детализация задач для `Tasks.txt` (Пользовательский запрос от [Текущая дата])
- (Лог действий из исходного AGENTS.md)...

## Финализация Task 66: 🖥️ UI.12 UI for Conflict Resolution
- (Лог действий из исходного AGENTS.md)...

## Финализация Task 65: 🖥️ UI.11 UI for Balance Tools
- (Лог действий из исходного AGENTS.md)...

## Task 67: 🖥️ UI.13 Backend API for Command List
- (Лог действий из исходного AGENTS.md)...

## Task 66: 🖥️ UI.12 UI for Conflict Resolution
- (Лог действий из исходного AGENTS.md)...

## Task 57: 🖥️ UI.3 UI for Player and Character Management
- (Лог действий из исходного AGENTS.md)...

## Session: [Current Date/Time] - Start Task 65
- (Лог действий из исходного AGENTS.md)...

## Task 65: 🖥️ UI.11 UI for Balance Tools
- (Лог действий из исходного AGENTS.md)...

## Task 64: 🖥️ UI.10 UI for Monitoring and Logging
- (Лог действий из исходного AGENTS.md)...

## Task 63: 🖥️ UI.9 UI for Global Entity Management
- (Лог действий из исходного AGENTS.md)...

## Task 62: 🖥️ UI.8 UI for Quest Management
- (Лог действий из исходного AGENTS.md)...

## Task 61: 🖥️ UI.7 UI for Faction and Relationship Management
- (Лог действий из исходного AGENTS.md)...

## Task 60: 🖥️ UI.6 UI for Inventory and Item Management
- (Лог действий из исходного AGENTS.md)...

## Task 56: 🖥️ UI.2 Basic UI Structure and Authentication Development (Backend part)
- (Лог действий из исходного AGENTS.md)...

## Tasks 57, 58, 59: 🖥️ UI Backend Preparation for Player, RuleConfig, and AI Moderation
- (Лог действий из исходного AGENTS.md)...

## Task 55: 🖥️ UI.1 UI Technology Stack Selection and Basic Structure.
- (Лог действий из исходного AGENTS.md)...

## Task 53: 🧠 11.4 NLU and Intent Recognition in Dialogue (Guild-Scoped)
- (Лог действий из исходного AGENTS.md)...

## Доработка Task 37: Интеграция влияния отношений с диалоговой системой (реализация `tone_hint`)
- (Лог действий из исходного AGENTS.md)...

## Task 52: 🧠 11.3 NPC Memory Management (Persistent, Per Guild)
- (Лог действий из исходного AGENTS.md)...

## Task 51: 🧠 11.2 Dialogue Context and Status (Guild-Scoped)
- (Лог действий из исходного AGENTS.md)...

## Task 50: 🧠 11.1 Dialogue Generation Module (LLM, Multy-i18n, According to Rules) - Сессия 2024-07-26 (Начало новой сессии)
- (Лог действий из исходного AGENTS.md)...

## Task 49: 🛠️ 15.3 Monitoring Tools (Guild-Scoped)
- (Лог действий из исходного AGENTS.md)...

## Доработка отложенной задачи: Интеграция влияния отношений с торговой системой (связано с Task 37 и Task 44)
- (Лог действий из исходного AGENTS.md)...

## Task 48: 🛠️ 15.2 Balance and Testing Tools (Per Guild)
- (Лог действий из исходного AGENTS.md)...

## Task 50: 🧠 11.1 Dialogue Generation Module (LLM, Multy-i18n, According to Rules)
- (Лог действий из исходного AGENTS.md)...

## Task 47: 🛠️ 15.1 Master Command System (Завершено 2024-07-18)
- (Лог действий из исходного AGENTS.md)...

## Рефакторинг Master Admin Commands (Пользовательская задача от 2024-07-16)
- (Лог действий из исходного AGENTS.md)...

## Проверка и завершение "Доработка Player.attributes_json для Task 32" (Отложенная задача)
- (Лог действий из исходного AGENTS.md)...

---
## Отложенные задачи
- **Интеграция влияния отношений с системами торговли и диалогов (связано с Task 37)**:
    - **Описание**: В рамках Task 37 была спроектирована логика влияния отношений на торговлю (корректировка цен) и диалоги (тон NPC, доступность опций).
        - Часть, касающаяся **торговой системы**, была проверена и подтверждена как реализованная. **Эта часть отложенной задачи выполнена.**
        - Часть, касающаяся **диалоговой системы (`tone_hint`)**, была реализована и протестирована. **Эта часть отложенной задачи выполнена.**
- **Обновление Pydantic `parse_obj_as`**:
    - **Описание**: В файле `src/core/ai_response_parser.py` используется метод `parse_obj_as`, который является устаревшим в Pydantic V2 и будет удален в V3.0.
    - **Необходимые действия**: Заменить `parse_obj_as(GeneratedEntity, entity_data)` на `TypeAdapter(GeneratedEntity).validate_python(entity_data)`. Это потребует импорта `TypeAdapter` из `pydantic`.
    - **Срок**: Выполнить при следующем значительном рефакторинге или обновлении зависимостей Pydantic.
- **Дальнейшее расширение и уточнение правил симуляции конфликтов**:
    - (Содержимое из исходного AGENTS.md)...
- **Дальнейшее расширение логики анализа в Анализаторе AI (связано с Task 48)**:
    - (Содержимое из исходного AGENTS.md)...
- **Реализация `dialogue_option_availability` в системе диалогов (связано с Task 37, отложенная часть интеграции влияния отношений)**:
    - (Содержимое из исходного AGENTS.md)...
- **Проблема с мокированием локальных импортов CRUD в `test_quest_master_commands.py` (Отложено из Task 62)**:
    - (Содержимое из исходного AGENTS.md)...
- **Проблема с моком `get_localized_text` в `tests/bot/commands/test_party_commands.py` (Отложено из Task 62)**:
    - (Содержимое из исходного AGENTS.md)...
- **Расхождение в формате `parsed_entities` в `tests/core/test_action_processor.py` (Отложено из Task 62)**:
    - (Содержимое из исходного AGENTS.md)...
- **Полная реализация UI Задач (вместо заглушек)**:
    - (Содержимое из исходного AGENTS.md)...
- **Рефакторинг PartyCog на Slash Commands**:
    - **Описание**: Cog `PartyCog` в `backend/bot/commands/party_commands.py` в настоящее время использует префиксные команды (`commands.group`). Согласно Task 1.2, команды управления партией должны быть реализованы как слеш-команды (`app_commands`).
    - **Необходимые действия**:
        1.  Изменить базовый класс `PartyCog` для наследования от `app_commands.Group` или использовать декораторы `@app_commands.command` для каждой команды.
        2.  Обновить все команды (`create`, `join`, `leave`, `disband`, `invite`, `kick`, `promote`, `view`) для использования `discord.Interaction` вместо `commands.Context`.
        3.  Скорректировать получение аргументов команд (например, `party_name: str`, `target_player: discord.Member`) для соответствия механизмам `app_commands`.
        4.  Обновить отправку ответов (`interaction.response.send_message` или `interaction.followup.send`).
        5.  Переписать или адаптировать существующие unit-тесты в `tests/bot/commands/test_party_commands.py` для работы с `app_commands` и мокирования `discord.Interaction`.
    - **Срок**: После завершения текущего этапа доработки функционала Task 1.2 и Task 1.3. Приоритет: высокий, для соответствия общему дизайну команд.

---
## требует доработки
*(Этот раздел для задач, описания которых в Tasks.txt были обновлены ИЛИ для фиксации недоработок в коде)*

### Task 0.1: Discord Bot Project Initialization and Basic Guild Integration
-   **Файл:** `backend/bot/core.py`
    -   `[TODO]` **Проблема:** Метод `on_error()` закомментирован. Рассмотреть необходимость глобального обработчика ошибок.
-   **Файл:** `backend/bot/events.py`
    -   `[УПУЩЕНИЕ]` **Проблема (Упущение):** В `on_guild_join()` приветственное сообщение отправляется без явного использования `GuildConfig.system_channel_id` или `notification_channel_id`. Выбор канала можно сделать более интеллектуальным.
    -   `[TODO]` **Проблема (TODO):** В `on_command_error()` для `CommandNotFound` закомментирован `await ctx.send(...)`.
-   **Файл:** `backend/src/bot/localization.py` (или аналогичный)
    -   `[ОТСУТСТВУЕТ ФУНКЦИОНАЛ]` **Проблема (Отсутствие):** Базовая система локализации (даже как плейсхолдер) не была явно создана, хотя упоминалась в плане.

### Task 0.3: Basic DB Interaction Utilities and Rule Configuration Access (Guild-Aware)
-   **Файл:** `backend/core/crud/crud_rule_config.py`
    -   `[НЕПОЛНАЯ РЕАЛИЗАЦИЯ]` **Проблема (Неполнота):** Модель `RuleConfig` не использует `TimestampMixin`, и код для ручного обновления `updated_at` в методе `create_or_update` закомментирован. Если отслеживание времени изменения правил важно, это требует доработки.

### Task 1.2: Player and Party System (ORM, Commands, Guild-Scoped)
-   **Файл:** `backend/bot/commands/party_commands.py` (`/party ...`)
    -   `[ОТКЛОНЕНИЕ ОТ ПЛАНА]` **Проблема:** Команды реализованы как префиксные (`commands.group`), а не слеш-команды (`app_commands`), как указано в Task 1.2. Рефакторинг вынесен в "Отложенные задачи". Локализация сообщений обратной связи требует отдельного этапа.

### Task 1.3: Movement Logic (Player/Party, Guild-Scoped)
-   **Файл:** `backend/core/movement_logic.py`
    -   `[НЕПОЛНАЯ РЕАЛИЗАЦИЯ]` **Проблема (`execute_move_for_player_action`):** Логика затрат на перемещение (время) залогирована, но эффект не применяется. Политики использования ресурсов партией (`party:movement:resource_source_policy`, `party:movement:item_source_policy`, `party:movement:quest_status_policy`) отмечены как TODO.
    -   `[TODO]` **Проблема (TODO):** В `_find_location_by_identifier()` улучшить поиск локации по имени, рассмотрев другие ключи в `name_i18n` (низкий приоритет).
-   **Файл:** `backend/core/game_events.py` (`on_enter_location`)
    -   `[НЕПОЛНАЯ РЕАЛИЗАЦИЯ]` **Проблема:** Функция `on_enter_location()` расширена, но фактическая отправка сообщений игрокам, запуск столкновений и AI-событий являются плейсхолдерами. Требуется механизм передачи ID `StoryLog` для полной интеграции с системой квестов.

### Task 2.1: Finalize Definition of ALL DB Schemas (i18n, Guild ID)
-   **Файл:** `backend/models/generated_faction.py`
    -   `[ТИП ДАННЫХ]` **Проблема:** Поля `name_i18n`, `description_i18n`, `ideology_i18n` используют `JSON` вместо `JsonBForSQLite`.
-   **Файл:** `backend/models/generated_npc.py`
    -   `[ТИП ДАННЫХ]` **Проблема:** Поля `name_i18n`, `description_i18n`, `npc_type_i18n` используют `JSON` вместо `JsonBForSQLite`.
-   **Файл:** `backend/models/global_event.py`
    -   `[ТИП ДАННЫХ]` **Проблема:** Поля `name_i18n`, `description_i18n`, `properties_json` используют `JSON` вместо `JsonBForSQLite`.
-   **Файл:** `backend/models/global_npc.py`
    -   `[ТИП ДАННЫХ]` **Проблема:** Поля `name_i18n`, `description_i18n`, `properties_json` используют `JSON` вместо `JsonBForSQLite`.
-   **Файл:** `backend/models/item.py`
    -   `[ТИП ДАННЫХ]` **Проблема:** Поля `name_i18n`, `description_i18n`, `item_type_i18n`, `item_category_i18n`, `properties_json` используют `JSON` вместо `JsonBForSQLite`.
-   **Файл:** `backend/models/pending_generation.py`
    -   `[ТИП ДАННЫХ]` **Проблема:** Поля `trigger_context_json`, `parsed_validated_data_json`, `validation_issues_json` используют `JSON` вместо `JsonBForSQLite`.

### Task 2.2: AI Prompt Preparation Module
-   **Файл:** `backend/core/ai_prompt_builder.py`
    -   `[ОТКЛОНЕНИЕ ОТ ПЛАНА]` **Проблема (Отклонение от плана):** Вместо единой API функции `prepare_ai_prompt` существует множество специализированных функций. Требуется подтверждение, является ли это приемлемым архитектурным решением.
    -   `[НЕПОЛНАЯ РЕАЛИЗАЦИЯ]` **Проблема (Неполнота):** Отсутствует явная реализация "словаря игровых терминов" для передачи AI.

### Task 2.3: AI Response Parsing and Validation Module
-   **Файл:** `backend/core/ai_response_parser.py`
    -   `[НЕПОЛНАЯ РЕАЛИЗАЦИЯ]` **Проблема (Существенная неполнота `_perform_semantic_validation`):** Отсутствуют семантические/контекстные проверки, проверка уникальности `static_id`, использование `GuildConfig.supported_languages_json`.
    -   `[ОТКЛОНЕНИЕ ОТ ПЛАНА]` **Проблема (Отклонение от плана):** Не используется структурированный `CustomValidationError`.
    -   `[ОТСУТСТВУЕТ ФУНКЦИОНАЛ]` **Проблема (Отсутствие):** Не реализована функция автокоррекции.

### Task 2.6: AI Generation, Moderation, and Saving Logic
-   **Файл:** `backend/core/ai_orchestrator.py`
    -   `[НЕПОЛНАЯ РЕАЛИЗАЦИЯ]` **Проблема (Недоработка `trigger_ai_generation_flow`):** Отсутствует уведомление Мастера через Discord.
    -   `[НЕПОЛНАЯ РЕАЛИЗАЦИЯ]` **Проблема (Существенная неполнота `save_approved_generation`):** Сохраняет не все типы сущностей, нет обработки связанных сущностей, нет разрешения внутренних ссылок.
    -   `[ОТСУТСТВУЕТ ФУНКЦИОНАЛ]` **Проблема (Отсутствие Post-Save Actions):** Нет логики для сброса статуса игрока или вызова игровых хуков.
-   **Файл:** команды модерации (`pending_generation_master_commands.py`)
    -   `[УПУЩЕНИЕ]` **Проблема (Мелкая недоработка):** Отсутствует явная команда `/master_pending_generation reject`.
